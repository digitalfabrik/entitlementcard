description: Restores and saves the node_modules directories of the npm workspaces.
steps:
  - restore_cache:
      keys:
      - v3-npm-{{ checksum "~/project/package-lock.json" }}
      - v3-npm
  - run:
      name: Install node dependencies with fallback
      command: |
        echo "Trying npm ci with cache..."
        if ! npm ci --cache ~/.npm --prefer-offline; then
          echo "npm ci failed â€” clearing cache and trying again"
          npm cache clean --force
          npm ci
        fi
  - save_cache:
      key: v3-npm-{{ checksum "~/project/package-lock.json" }}
      paths:
        - ~/.npm
      when: on_success
