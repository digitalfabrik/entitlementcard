### AUTO GENERATED. DO NOT MODIFY. ###
# This file should be auto generated by the files in the src folder.
# You can update it by running `./scripts/circleci-update-config.sh` from the project root.
commands:
    check_backend_health:
        steps:
            - run:
                command: apt update -y && apt install -y curl sudo
                name: Install curl and sudo
            - run:
                command: apt install ca-certificates-java -y
                name: Install ca-certificates-java
            - run:
                command: apt install openjdk-17-jre-headless -y
                name: Install openjdk-17-jre-headless
            - run:
                command: dpkg -i ~/attached_workspace/debs/backend/eak-backend*.deb
                name: Install backend
            - run:
                command: /opt/ehrenamtskarte/backend/bin/backend migrate
                name: Run migrate
            - run:
                background: true
                command: /opt/ehrenamtskarte/backend/bin/backend execute
                name: Start backend
            - run:
                command: curl --retry 120 --retry-delay 1 --retry-all-errors http://0.0.0.0:8000/health
                name: Check health
    check_circleci_config:
        description: This command builds the circle config from the files in src and validates that it is up-to-date and valid.
        steps:
            - run:
                command: curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | sudo bash
                name: Install CircleCI CLI
            - run:
                command: scripts/circleci-update-config
                name: Build circle config
                working_directory: ~/project
            - run:
                command: |
                    FILES_MODIFIED=""
                    setcommit () {
                      FILES_MODIFIED=$(git status -s | grep -i -E '.*circleci/config.yml')
                    }
                    setcommit || true
                    if [ -z "$FILES_MODIFIED" ]
                    then
                      echo "The CircleCI config is up to date."
                      exit 0;
                    else
                      echo "The CircleCI config is not up to date. You can update it by running the `./scripts/circleci-update-config` script."
                      exit 1;
                    fi
                name: CircleCI config up to date
            - run:
                command: circleci config validate
                name: Validate circle config
                working_directory: ~/project
    install_app_toolbelt:
        steps:
            - run:
                command: npm ci --workspaces=false
                name: Install app-toolbelt
                working_directory: ~/project
    install_fastlane:
        description: Restores and saves fastlane cache of the current directory.
        parameters:
            directory:
                default: .
                type: string
        steps:
            - restore_cache:
                keys:
                    - v1-gems-{{ arch }}-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                    - v1-gems-{{ arch }}-
                name: Restore gems
            - run:
                command: |
                    bundle config set path '~/.bundle'
                    bundle check || bundle install
                name: Install fastlane
                working_directory: << parameters.directory >>
            - save_cache:
                key: v1-gems-{{ arch }}-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                name: Save gems
                paths:
                    - ~/.bundle
    install_flutter:
        parameters:
            precache:
                default: none
                enum:
                    - none
                    - android
                    - ios
                type: enum
        steps:
            - run:
                command: |
                    curl -fsSL https://raw.githubusercontent.com/leoafarias/fvm/refs/heads/main/scripts/install.sh | bash
                    curl -sL https://raw.githubusercontent.com/leoafarias/fvm/refs/heads/main/scripts/install.sh | shasum -a 256
                name: Install fvm
            - restore_cache:
                keys:
                    - v1-fvm-{{ arch }}-{{ checksum ".fvmrc" }}-{{ checksum "pubspec.yaml" }}-{{ checksum "pubspec.lock"  }}
                    - v1-fvm-{{ arch }}-
                name: Restore flutter
            - run:
                command: |
                    fvm install
                    fvm flutter config --no-analytics
                    fvm flutter --version
                name: Install flutter
            - run:
                command: fvm flutter pub get --enforce-lockfile
                name: Install flutter packages
            - unless:
                condition:
                    equal:
                        - << parameters.precache >>
                        - none
                steps:
                    - run:
                        command: fvm flutter precache --<< parameters.precache >>
                        name: Precache flutter binary artifacts
                        working_directory: << parameters.precache >>
            - save_cache:
                key: v1-fvm-{{ arch }}-{{ checksum ".fvmrc" }}-{{ checksum "pubspec.yaml" }}-{{ checksum "pubspec.lock"  }}
                name: Save flutter
                paths:
                    - .fvm
                    - ~/fvm
    install_node_modules:
        description: Restores and saves the node_modules directories of the npm workspaces.
        steps:
            - restore_cache:
                keys:
                    - v1-node-modules-{{ checksum "~/project/package-lock.json" }}
                    - v1-node-modules
            - run:
                command: npm ci
                name: Install node dependencies for npm workspaces
            - save_cache:
                key: v1-node-modules-{{ checksum "~/project/package-lock.json" }}
                paths:
                    - ~/project/node_modules
                    - ~/project/administration/node_modules
                    - ~/project/frontend/build-configs/node_modules
    install_pods:
        description: Restores and saves the cocoa pods cache.
        steps:
            - restore_cache:
                keys:
                    - v1-pods-{{ checksum "ios/Podfile.lock" }}
                name: Restore pods
            - run:
                command: |
                    bundle exec pod update
                    bundle exec pod install
                name: Install pods
                working_directory: ios
            - save_cache:
                key: v1-pods-{{ checksum "ios/Podfile.lock" }}
                name: Save pods
                paths:
                    - ~/Library/Caches/CocoaPods
    install_protobuf_linux:
        steps:
            - run:
                command: |
                    curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-linux-x86_64.zip"
                    unzip protoc*.zip -d $HOME/.local
                    echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
                name: Install protobuf
    install_protobuf_mac:
        steps:
            - run:
                command: |
                    curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-osx-universal_binary.zip"
                    unzip protoc*.zip -d $HOME/.local
                    echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
                name: Install protobuf
    notify:
        description: Send a notification (to Mattermost) at the end of a job, based on success or failure. Must be the last step in a job.
        parameters:
            allow_all_branches:
                default: false
                type: boolean
            channel:
                default: entitlementcard-notifications
                type: string
            failure_mentions:
                default: '@andreas.fischer @viktoria.seluianova @bahaa.tuffaha @andre.wachter @steffen.kleinle'
                type: string
            success_mentions:
                default: ""
                type: string
            success_message:
                default: ""
                type: string
        steps:
            - run:
                command: |
                    echo 'export MM_MESSAGE=":fire: [${CIRCLE_JOB}](${CIRCLE_BUILD_URL}) failed on branch ${CIRCLE_BRANCH}! :fire: << parameters.failure_mentions >>"' >> $BASH_ENV
                name: Mattermost - Prepare failure message
                when: on_fail
            - run:
                command: echo 'export MM_MESSAGE="<< parameters.success_message >>"' >> $BASH_ENV
                name: Mattermost - Prepare success message
                when: on_success
            - run:
                command: scripts/notify-mattermost << parameters.channel >> << parameters.allow_all_branches >>
                name: Mattermost Status Alert
                when: always
                working_directory: ~/project
    persist_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: |
                    cat ${BASH_ENV} >> environment_variables
                    cat ${BASH_ENV}
                name: Save environment variables
            - persist_to_workspace:
                paths:
                    - environment_variables
                root: ./
    prepare_workspace:
        description: Checkout repository, attach the workspace at ~/attached_workspace and restore environment variables
        steps:
            - checkout:
                path: ~/project
            - attach_workspace:
                at: ~/attached_workspace
            - run:
                command: |
                    ls -A ~/attached_workspace
                    ls -AR ~/attached_workspace
                name: Attached workspace contents
            - run:
                command: "touch ~/attached_workspace/environment_variables \ncat ~/attached_workspace/environment_variables >> ${BASH_ENV}\ncat ~/attached_workspace/environment_variables\n"
                name: Restore environment variables
jobs:
    build_administration:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - prepare_workspace
            - install_protobuf_linux
            - install_node_modules
            - run:
                command: npm run build --version_name=${NEW_VERSION_NAME}
                name: Build
            - persist_to_workspace:
                paths:
                    - administration/build
                root: ~/project
            - notify
        working_directory: ~/project/administration
    build_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
            GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m" -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        parameters:
            build_config:
                description: Name of the build config to use
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
        resource_class: large
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - install_flutter:
                precache: android
            - install_fastlane:
                directory: android
            - restore_cache:
                keys:
                    - v1-gradle-{{ checksum "android/build.gradle.kts" }}-{{ checksum "android/app/build.gradle.kts" }}-{{ checksum "android/settings.gradle.kts" }}
            - run:
                command: bundle exec fastlane keystore
                name: '[FL] Prepare Android Keystore'
                working_directory: android
            - run:
                command: bundle exec fastlane android build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} build_config_name:<< parameters.build_config >>
                name: '[FL] Build'
                working_directory: android
            - save_cache:
                key: v1-gradle-{{ checksum "android/build.gradle.kts" }}-{{ checksum "android/app/build.gradle.kts" }}-{{ checksum "android/settings.gradle.kts" }}
                paths:
                    - ~/.gradle/caches
                    - ~/.gradle/wrapper
            - run:
                command: |
                    mv build/app/outputs/bundle/<< parameters.build_config >>Release/app-<< parameters.build_config >>-release.aab ~/attached_workspace/<< parameters.build_config >>.aab
                    mv build/app/outputs/apk/<< parameters.build_config >>/release/app-<< parameters.build_config >>-release.apk ~/attached_workspace/<< parameters.build_config >>.apk
                name: Move artifacts
            - persist_to_workspace:
                paths:
                    - << parameters.build_config >>.aab
                    - << parameters.build_config >>.apk
                root: ~/attached_workspace
            - store_artifacts:
                path: ~/attached_workspace
            - notify
        working_directory: ~/project/frontend
    build_backend:
        docker:
            - image: cimg/openjdk:17.0.13-node
        environment:
            _JAVA_OPTIONS: -Xmx3g
            GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        steps:
            - prepare_workspace
            - install_protobuf_linux
            - setup_remote_docker:
                docker_layer_caching: true
            - run:
                command: |
                    git submodule sync
                    git submodule update --init
                name: Setup submodules
            - restore_cache:
                keys:
                    - v1-gradle-{{ checksum "build.gradle.kts" }}
            - run:
                command: ./gradlew build
                name: Build backend
            - save_cache:
                key: v1-gradle-{{ checksum "build.gradle.kts" }}
                paths:
                    - ~/.gradle/caches
                    - ~/.gradle/wrapper
            - persist_to_workspace:
                paths:
                    - backend/build/distributions/*
                root: ~/project
            - notify
        working_directory: ~/project/backend
    build_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 16.1.0
        parameters:
            build_config:
                description: Name of the build config to use
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - run:
                command: softwareupdate --install-rosetta --agree-to-license
                name: Install rosetta
            - install_flutter:
                precache: ios
            - install_fastlane:
                directory: ios
            - install_pods
            - run:
                command: bundle exec fastlane ios build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} build_config_name:<< parameters.build_config >>
                name: '[FL] Build'
                working_directory: ios
            - store_artifacts:
                path: ~/<< parameters.build_config >>.ipa
            - persist_to_workspace:
                paths:
                    - << parameters.build_config >>.ipa
                root: ~/
            - notify
        working_directory: ~/project/frontend
    bump_version:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            platforms:
                default: all
                description: Set one or multiple platforms for git tag f.e. "web" or "web/native"
                type: string
            prepare_delivery:
                default: false
                description: Whether to prepare for a delivery. If true, the version bump is committed.
                type: boolean
        resource_class: small
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - run:
                command: echo "export NEW_VERSION_NAME=$(npx --no app-toolbelt v0 version calc | jq .versionName)" >> ${BASH_ENV}
                name: Calculate next version name
            - run:
                command: echo "export NEW_VERSION_CODE=$(npx --no app-toolbelt v0 version calc | jq .versionCode)" >> ${BASH_ENV}
                name: Calculate next version code
            - when:
                condition: << parameters.prepare_delivery >>
                steps:
                    - run:
                        command: npx --no app-toolbelt v0 release bump-to ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --branch ${CIRCLE_BRANCH} --platforms << parameters.platforms >>
                        name: Bump git version
            - when:
                condition:
                    and:
                        - << parameters.prepare_delivery >>
                        - not:
                            equal:
                                - main
                                - << pipeline.git.branch >>
                steps:
                    - notify:
                        allow_all_branches: true
                        success_message: Delivery was made on branch << pipeline.git.branch >>. Make sure to merge this branch before next delivery.
            - persist_environment_variables
            - notify
    check_administration:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - prepare_workspace
            - check_circleci_config
            - install_protobuf_linux
            - install_node_modules
            - run:
                command: npm run ts:check
                name: Typescript
            - run:
                command: npm run lint
                name: Lint
            - run:
                command: npm run check-circular-deps
                name: Check circular dependencies
            - run:
                command: npm run test:coverage -- --maxWorkers=2
                name: Run tests and generate coverage report
            - store_artifacts:
                destination: ~/attached_workspace/coverage
                path: src/coverage
            - notify
        working_directory: ~/project/administration
    check_backend:
        docker:
            - image: cimg/openjdk:17.0.13-node
        environment:
            _JAVA_OPTIONS: -Xmx3g
            GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        steps:
            - prepare_workspace
            - check_circleci_config
            - install_protobuf_linux
            - setup_remote_docker:
                docker_layer_caching: true
            - run:
                command: |
                    git submodule sync
                    git submodule update --init
                name: Setup submodules
            - restore_cache:
                keys:
                    - v1-gradle-{{ checksum "build.gradle.kts" }}
            - run:
                command: |
                    ./gradlew run --args="graphql-export ../specs/backend-api.graphql"
                    git diff --exit-code
                name: Check GraphQL scheme stability
            - run:
                command: ./gradlew ktlintCheck
                name: Check backend formatting
            - run:
                command: ./gradlew test
                name: Test
            - store_test_results:
                path: ./build/test-results
            - run:
                command: ./gradlew koverLog koverHtmlReport
                name: Generate test coverage report
            - store_artifacts:
                destination: test-coverage-report
                path: ./build/reports/kover/html
            - save_cache:
                key: v1-gradle-{{ checksum "build.gradle.kts" }}
                paths:
                    - ~/.gradle/caches
                    - ~/.gradle/wrapper
            - notify
        working_directory: ~/project/backend
    check_frontend:
        docker:
            - image: cimg/node:20.18.0
        resource_class: small
        steps:
            - prepare_workspace
            - check_circleci_config
            - install_app_toolbelt
            - install_flutter
            - run:
                command: fvm dart format -l 120 -o none --set-exit-if-changed .
                name: Check formatting
            - run:
                command: fvm flutter pub run build_runner build --define "df_build_config=name=bayern"
                name: Setup build config
            - run:
                command: |
                    fvm flutter analyze --fatal-infos --fatal-warnings
                    fvm flutter analyze pubs/df_build_config --fatal-infos --fatal-warnings
                name: Analyze and lint
            - run:
                command: |
                    fvm flutter test
                    fvm flutter test pubs/df_build_config
                name: Test
            - notify
        working_directory: ~/project/frontend
    deliver_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            build_config:
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        resource_class: small
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - install_fastlane
            - run:
                command: bundle exec fastlane android upload_to_playstore build_config_name:<< parameters.build_config >> production_delivery:"<< parameters.production_delivery >>" version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                name: '[FL] Play Store Upload'
            - notify
        working_directory: ~/project/frontend/android
    deliver_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 16.1.0
        parameters:
            build_config:
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - install_fastlane
            - when:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios appstoreconnect_upload build_config_name:<< parameters.build_config >> ipa_path:attached_workspace/<< parameters.build_config >>.ipa version_name:${NEW_VERSION_NAME}
                        name: '[FL] App Store Connect Upload'
            - unless:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios upload_to_test_flight build_config_name:<< parameters.build_config >> ipa_path:attached_workspace/<< parameters.build_config >>.ipa
                        name: '[FL] TestFlight Upload'
            - notify
        working_directory: ~/project/frontend/ios
    deliver_server:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            production:
                description: Whether builds are delivered to production or beta.
                type: boolean
        steps:
            - prepare_workspace
            - add_ssh_keys:
                fingerprints:
                    - a1:3f:a7:c3:ff:12:40:1d:85:de:a7:ab:12:3f:cc:05
            - when:
                condition: << parameters.production >>
                steps:
                    - run:
                        command: |
                            mkdir -p ~/.ssh
                            echo ${APT_FINGERPRINT_PRODUCTION} >> ~/.ssh/known_hosts
                        name: Add ssh fingerprint
                    - run:
                        command: |
                            echo "Uploading:" ~/attached_workspace/debs/administration/*.deb
                            sftp -b - ci@entitlementcard.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/administration/*.deb"
                        name: Upload administration
                    - run:
                        command: |
                            echo "Uploading:" ~/attached_workspace/debs/backend/*.deb
                            sftp -b - ci@entitlementcard.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/backend/*.deb"
                        name: Upload backend
                    - run:
                        command: curl https://webhook.entitlementcard.tuerantuer.org/hooks/install-backend-admin-$EAK_WEBHOOK
                        name: Install packages
            - unless:
                condition: << parameters.production >>
                steps:
                    - run:
                        command: |
                            mkdir -p ~/.ssh
                            echo ${APT_FINGERPRINT_STAGING} >> ~/.ssh/known_hosts
                        name: Add ssh fingerprint
                    - run:
                        command: |
                            echo "Uploading:" ~/attached_workspace/debs/administration/*.deb
                            sftp -b - ci@entitlementcard-test.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/administration/*.deb"
                        name: Upload administration
                    - run:
                        command: |
                            echo "Uploading:" ~/attached_workspace/debs/backend/*.deb
                            sftp -b - ci@entitlementcard-test.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/backend/*.deb"
                        name: Upload backend
                    - run:
                        command: curl https://webhook.entitlementcard-test.tuerantuer.org/hooks/install-backend-admin-$EAK_WEBHOOK
                        name: Install packages
            - notify
    notify_release:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            production_delivery:
                description: Whether builds are delivered to the production or beta lane of the play store.
                type: boolean
        resource_class: small
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - run:
                command: echo "export RELEASE_ID='$(npx --no app-toolbelt v0 release create all ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} <<# parameters.production_delivery >>--production-release<</ parameters.production_delivery >>)'" >> ${BASH_ENV}
                name: Create github release
            - run:
                command: npx --no app-toolbelt v0 release upload --releaseId ${RELEASE_ID} --files "$(ls ~/attached_workspace/*.apk)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload android apks to github release
            - run:
                command: npx --no app-toolbelt v0 release upload --releaseId ${RELEASE_ID} --files "$(ls ~/attached_workspace/debs/administration/*.deb)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload administration debian package to github release
            - run:
                command: npx --no app-toolbelt v0 release upload --releaseId ${RELEASE_ID} --files "$(ls ~/attached_workspace/debs/backend/*.deb)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload backend debian packages to github release
            - notify:
                allow_all_branches: true
                channel: releases
                success_message: <<^ parameters.production_delivery >>[Beta] <</ parameters.production_delivery >>Ehrenamtskarte Bayern, Sozialpass NÃ¼rnberg und Sozialpass Koblenz ${NEW_VERSION_NAME} have been released successfully! https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/releases/tag/${NEW_VERSION_NAME}-all
    pack_administration:
        docker:
            - image: debian:12
        steps:
            - prepare_workspace
            - run:
                command: scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -f ~/attached_workspace/administration/build -d "Administration backend for the Ehrenamtskarte app" -n "eak-administration"
                name: Pack administration
            - run:
                command: |
                    mkdir -p ~/attached_workspace/debs/administration
                    mv *.deb ~/attached_workspace/debs/administration
                name: Move package
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/administration/*.deb
                root: ~/attached_workspace
            - notify
    pack_backend:
        docker:
            - image: debian:12
            - environment:
                - POSTGRES_DB=ehrenamtskarte
                - POSTGRES_USER=postgres
                - POSTGRES_PASSWORD=postgres
              image: postgis/postgis:13-3.0
        steps:
            - prepare_workspace
            - run:
                command: scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -t ~/attached_workspace/backend/build/distributions/*.tar -s scripts/eak-backend.service -d "Backend server for the Ehrenamtskarte app" -n "eak-backend" -c "openjdk-17-jre-headless"
                name: Pack backend
            - run:
                command: |
                    mkdir -p ~/attached_workspace/debs/backend
                    mv *.deb ~/attached_workspace/debs/backend
                name: Move package
            - check_backend_health
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/backend/*.deb
                root: ~/attached_workspace
            - notify
    pack_martin:
        docker:
            - image: debian:12
        steps:
            - prepare_workspace
            - run:
                command: apt update -y && apt install -y curl
                name: Install curl
            - run:
                command: curl -LO "https://github.com/maplibre/martin/releases/download/v0.13.0/martin-x86_64-unknown-linux-gnu.tar.gz"
                name: Download martin
            - run:
                command: |
                    cp docker/martin-config.yaml config.yaml
                    tar -xvzf martin-x86_64-unknown-linux-gnu.tar.gz -C . martin
                    scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -d "Martin tile server for the Ehrenamtskarte app" -n "eak-martin" -s scripts/eak-martin.service -C "/opt/ehrenamtskarte/martin/config.yaml" -M .
                name: Pack martin
            - run:
                command: |
                    mkdir -p ~/attached_workspace/debs/backend
                    mv *.deb ~/attached_workspace/debs/backend
                name: Move package
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/backend/*.deb
                root: ~/attached_workspace
            - notify
    pack_meta:
        docker:
            - image: debian:12
        steps:
            - prepare_workspace
            - run:
                command: scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -d "Meta package for the Ehrenamtskarte app" -n "eak" -c "eak-backend, eak-administration, eak-martin"
                name: Pack meta
            - run:
                command: |
                    mkdir -p ~/attached_workspace/debs/backend
                    cp *.deb ~/attached_workspace/debs/backend
                name: Move package
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/backend/*.deb
                root: ~/attached_workspace
            - notify
    promote_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            build_config:
                default: bayern
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
        resource_class: small
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - install_fastlane
            - run:
                command: bundle exec fastlane android playstore_promote build_config_name:<< parameters.build_config >>
                name: '[FL] Play Store Promotion'
            - notify
        working_directory: ~/project/frontend/android
    promote_github_release:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - run:
                command: npx --no app-toolbelt v0 release promote --platform all --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Remove prerelease flag from github release
            - notify
    promote_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 16.1.0
        parameters:
            build_config:
                default: bayern
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
        steps:
            - prepare_workspace
            - install_app_toolbelt
            - install_fastlane
            - run:
                command: bundle exec fastlane ios appstoreconnect_promote build_config_name:<< parameters.build_config >>
                name: '[FL] Appstore Connect Store Promotion'
            - notify
        working_directory: ~/project/frontend/ios
    promote_server:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - prepare_workspace
            - add_ssh_keys:
                fingerprints:
                    - a1:3f:a7:c3:ff:12:40:1d:85:de:a7:ab:12:3f:cc:05
            - run:
                command: |
                    mkdir -p ~/.ssh
                    echo ${APT_FINGERPRINT_STAGING} >> ~/.ssh/known_hosts
                    echo ${APT_FINGERPRINT_PRODUCTION} >> ~/.ssh/known_hosts
                    scp ci@entitlementcard-test.tuerantuer.org:/srv/local-apt-repository/eak*.deb ci@entitlementcard.tuerantuer.org:/srv/local-apt-repository/
                name: Transfer artifacts to production
            - run:
                command: |
                    curl https://webhook.entitlementcard.tuerantuer.org/hooks/install-backend-admin-$EAK_WEBHOOK
                name: Install administration & backend packages via webhook
            - notify
parameters:
    run_commit:
        default: true
        type: boolean
    run_commit_main:
        default: run_if_on_main
        enum:
            - run_if_on_main
            - run
            - skip
        type: enum
    run_delivery_beta_all:
        default: false
        type: boolean
    run_delivery_beta_backend_administration:
        default: false
        type: boolean
    run_delivery_beta_frontend:
        default: false
        type: boolean
    run_delivery_production_backend_administration:
        default: false
        type: boolean
    run_delivery_production_frontend:
        default: false
        type: boolean
    run_promotion_all:
        default: false
        type: boolean
    run_promotion_backend_administration:
        default: false
        type: boolean
    run_promotion_frontend:
        default: false
        type: boolean
shell: /bin/bash -eo pipefail
version: 2.1
workflows:
    commit:
        jobs:
            - check_backend
            - check_administration
            - check_frontend
        when:
            and:
                - << pipeline.parameters.run_commit >>
                - not:
                    equal:
                        - main
                        - << pipeline.git.branch >>
    commit_main:
        jobs:
            - bump_version:
                prepare_delivery: false
            - pack_martin:
                requires:
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - check_administration
            - build_administration:
                requires:
                    - bump_version
                    - check_administration
            - pack_administration:
                requires:
                    - build_administration
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - bump_version
                    - build_backend
            - check_frontend
            - build_android:
                build_config: bayern
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                requires:
                    - bump_version
                    - check_frontend
            - build_ios:
                build_config: bayern
                context:
                    - tuerantuer-apple
                    - fastlane-match
                requires:
                    - bump_version
                    - check_frontend
        when:
            or:
                - equal:
                    - << pipeline.parameters.run_commit_main >>
                    - run
                - and:
                    - equal:
                        - << pipeline.parameters.run_commit_main >>
                        - run_if_on_main
                    - equal:
                        - main
                        - << pipeline.git.branch >>
    delivery_beta_all:
        jobs:
            - bump_version:
                context:
                    - deliverino
                prepare_delivery: true
            - check_frontend
            - build_android:
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                context:
                    - tuerantuer-google-play
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                production_delivery: false
                requires:
                    - build_android-<< matrix.build_config >>
            - build_ios:
                context:
                    - tuerantuer-apple
                    - fastlane-match
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                context:
                    - tuerantuer-apple
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                production_delivery: false
                requires:
                    - build_ios-<< matrix.build_config >>
            - pack_martin:
                requires:
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - check_administration
            - build_administration:
                requires:
                    - bump_version
                    - check_administration
            - pack_administration:
                requires:
                    - build_administration
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - bump_version
                    - build_backend
            - deliver_server:
                context:
                    - credentials-ehrenamtskarte
                production: false
                requires:
                    - pack_administration
                    - pack_backend
                    - pack_martin
                    - pack_meta
            - notify_release:
                context:
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_android
                    - deliver_ios
                    - deliver_server
        when: << pipeline.parameters.run_delivery_beta_all >>
    delivery_beta_backend_administration:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: web
                prepare_delivery: true
            - pack_martin:
                requires:
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - check_administration
            - build_administration:
                requires:
                    - bump_version
                    - check_administration
            - pack_administration:
                requires:
                    - build_administration
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - bump_version
                    - build_backend
            - deliver_server:
                context:
                    - credentials-ehrenamtskarte
                production: false
                requires:
                    - pack_administration
                    - pack_backend
                    - pack_martin
                    - pack_meta
            - notify_release:
                context:
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_server
        when: << pipeline.parameters.run_delivery_beta_backend_administration >>
    delivery_beta_frontend:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: native
                prepare_delivery: true
            - check_frontend
            - build_android:
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                context:
                    - tuerantuer-google-play
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                production_delivery: false
                requires:
                    - build_android-<< matrix.build_config >>
            - build_ios:
                context:
                    - tuerantuer-apple
                    - fastlane-match
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                context:
                    - tuerantuer-apple
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                production_delivery: false
                requires:
                    - build_ios-<< matrix.build_config >>
            - notify_release:
                context:
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_android
                    - deliver_ios
        when: << pipeline.parameters.run_delivery_beta_frontend >>
    delivery_production_backend_administration:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: web
                prepare_delivery: true
            - pack_martin:
                requires:
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - check_administration
            - build_administration:
                requires:
                    - bump_version
                    - check_administration
            - pack_administration:
                requires:
                    - build_administration
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - bump_version
                    - build_backend
            - deliver_server:
                context:
                    - credentials-ehrenamtskarte
                production: true
                requires:
                    - pack_administration
                    - pack_backend
                    - pack_martin
                    - pack_meta
            - notify_release:
                context:
                    - deliverino
                production_delivery: true
                requires:
                    - deliver_server
        when: << pipeline.parameters.run_delivery_production_backend_administration >>
    delivery_production_frontend:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: native
                prepare_delivery: true
            - check_frontend
            - build_android:
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                context:
                    - tuerantuer-google-play
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                production_delivery: true
                requires:
                    - build_android-<< matrix.build_config >>
            - build_ios:
                context:
                    - tuerantuer-apple
                    - fastlane-match
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                context:
                    - tuerantuer-apple
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
                production_delivery: true
                requires:
                    - build_ios-<< matrix.build_config >>
            - notify_release:
                context:
                    - deliverino
                production_delivery: true
                requires:
                    - deliver_android
                    - deliver_ios
        when: << pipeline.parameters.run_delivery_production_frontend >>
    promotion_all:
        jobs:
            - promote_android:
                context:
                    - mattermost
                    - tuerantuer-google-play
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
            - promote_ios:
                context:
                    - mattermost
                    - tuerantuer-apple
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
            - promote_server:
                context:
                    - credentials-ehrenamtskarte
            - promote_github_release:
                context:
                    - deliverino
                requires:
                    - promote_android
                    - promote_ios
                    - promote_server
        when: << pipeline.parameters.run_promotion_all >>
    promotion_backend_administration:
        jobs:
            - promote_server:
                context:
                    - credentials-ehrenamtskarte
        when: << pipeline.parameters.run_promotion_backend_administration >>
    promotion_frontend:
        jobs:
            - promote_android:
                context:
                    - mattermost
                    - tuerantuer-google-play
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
            - promote_ios:
                context:
                    - mattermost
                    - tuerantuer-apple
                matrix:
                    parameters:
                        build_config:
                            - bayern
                            - nuernberg
                            - koblenz
        when: << pipeline.parameters.run_promotion_frontend >>

