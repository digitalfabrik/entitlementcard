### AUTO GENERATED. DO NOT MODIFY. ###
# This file should be auto generated by the files in the src folder.
# You can update it by running `./scripts/circleci-update-config.sh` from the project root.
commands:
    check_circleci_config:
        description: This command builds the circle config from the files in src and validates that it is up-to-date and valid.
        steps:
            - run:
                command: curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | sudo bash
                name: Install CircleCI CLI
            - run:
                command: ./scripts/circleci-update-config
                name: Build circle config
            - run:
                command: |
                    FILES_MODIFIED=""
                    setcommit () {
                      FILES_MODIFIED=$(git status -s | grep -i -E '.*circleci/config.yml')
                    }
                    setcommit || true
                    if [ -z "$FILES_MODIFIED" ]
                    then
                      echo "The CircleCI config is up to date."
                      exit 0;
                    else
                      echo "The CircleCI config is not up to date. You can update it by running the `./scripts/circleci-update-config` script."
                      exit 1;
                    fi
                name: CircleCI config up to date
            - run:
                command: circleci config validate
                name: Validate circle config
    install_app_toolbelt:
        steps:
            - setup_npm_global
            - run:
                command: npm install --unsafe-perm -g https://github.com/digitalfabrik/app-toolbelt/archive/refs/heads/main.tar.gz
                name: Install app-toolbelt
    install_dart_linux:
        steps:
            - run:
                command: |-
                    curl -o dart.deb https://storage.googleapis.com/dart-archive/channels/stable/release/3.3.1/linux_packages/dart_3.3.1-1_amd64.deb
                    sudo dpkg -i dart.deb
                name: Install Dart
    install_dart_mac:
        steps:
            - restore_cache:
                keys:
                    - brew-dart-4
            - run:
                command: |
                    brew tap dart-lang/dart
                    brew install dart@3.3.1
                    brew link dart@3.3.1
                name: Install Dart
            - save_cache:
                key: brew-dart-4
                paths:
                    - /usr/local/Cellar/dart/
                    - /usr/local/Homebrew/Library/Taps/dart-lang/homebrew-dart
                    - ~/Library/Caches/Homebrew
    install_fvm:
        steps:
            - run:
                command: |
                    dart pub global activate fvm
                    echo 'export PATH=$HOME/.pub-cache/bin:$PATH' >> $BASH_ENV
                    export PATH="$PATH":"$HOME/.pub-cache/bin"
                name: Install FVM
            - restore_cache:
                keys:
                    - fvm-0-{{ checksum "frontend/.fvmrc" }}-{{ arch }}
            - run:
                command: fvm install
                name: Install Flutter
                working_directory: ~/project/frontend/
            - save_cache:
                key: fvm-0-{{ checksum "frontend/.fvmrc" }}-{{ arch }}
                paths:
                    - .fvm
                    - ~/fvm/
            - run:
                command: fvm flutter --version
                name: Show Flutter version
                working_directory: ~/project/frontend/
            - run:
                command: fvm flutter config --no-analytics
                name: Configure Flutter
                working_directory: ~/project/frontend/
    install_protobuf_linux:
        parameters:
            dart_plugin:
                default: false
                type: boolean
        steps:
            - run:
                command: |
                    curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-linux-x86_64.zip"
                    unzip protoc*.zip -d $HOME/.local
                    echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
                name: Install protobuf from GitHub
    install_protobuf_mac:
        steps:
            - run:
                command: |
                    curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-osx-universal_binary.zip"
                    unzip protoc*.zip -d $HOME/.local
                    echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
                name: Install protobuf
    notify:
        description: Send a notification (to Mattermost) at the end of a job, based on success or failure. Must be the last step in a job.
        parameters:
            allow-all-branches:
                default: false
                type: boolean
            channel:
                default: entitlementcard-notifications
                type: string
            failure_mentions:
                default: '@stefanie.metzger @andreas.fischer'
                type: string
            success_mentions:
                default: ""
                type: string
            success_message:
                default: ""
                type: string
        steps:
            - run:
                command: |
                    echo 'export MM_MESSAGE=":fire: The [${CIRCLE_JOB}](${CIRCLE_BUILD_URL}) job has failed on the ${CIRCLE_BRANCH} branch! :fire: << parameters.failure_mentions >>"' >> $BASH_ENV
                name: Mattermost - Prepare failure message
                when: on_fail
            - run:
                command: |
                    echo 'export MM_MESSAGE="<< parameters.success_message >>"' >> $BASH_ENV
                name: Mattermost - Prepare success message
                when: on_success
            - run:
                command: |
                    app-toolbelt v0 notify mattermost --message "${MM_MESSAGE}" --channel << parameters.channel >> <<#parameters.allow-all-branches>>--allow-all-branches<</parameters.allow-all-branches>>
                name: Mattermost Status Alert
                when: always
    persist_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: cat ${BASH_ENV}
                name: List environment variables
            - run:
                command: cat ${BASH_ENV} >> environment_variables
                name: Save environment variables to file
            - persist_to_workspace:
                paths:
                    - environment_variables
                root: ./
    prepare_workspace:
        description: Attach the workspace at ~/attached_workspace and list its contents
        steps:
            - attach_workspace:
                at: ~/attached_workspace
            - run:
                command: ls -A ~/attached_workspace
                name: Attached workspace contents
            - run:
                command: ls -AR ~/attached_workspace
                name: Recursively list attached workspace contents
    restore_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: cat ~/attached_workspace/environment_variables
                name: List environment variables
            - run:
                command: cat ~/attached_workspace/environment_variables >> ${BASH_ENV}
                name: Restore environment variables
    restore_gradle_caches:
        description: Restores and saves the gradle caches for backend.
        steps:
            - restore_cache:
                key: v3-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - restore_cache:
                key: v3-gradle-cache-{{ checksum "build.gradle.kts" }}
    restore_npm_cache:
        description: Restores and saves the node_modules directories of the npm workspaces.
        steps:
            - restore_cache:
                keys:
                    - v2-node-modules-{{ checksum "package.json" }}-{{checksum "package-lock.json" }}-{{ checksum "administration/package.json" }}-{{ checksum "frontend/build-configs/package.json" }}
            - run:
                command: '[ ! -d node_modules ] && npm ci --ignore-scripts --loglevel warn --yes || echo package.json and package-lock.json unchanged. Using cache.'
                name: Install node dependencies for npm workspaces
            - save_cache:
                key: v2-node-modules-{{ checksum "package.json" }}-{{checksum "package-lock.json" }}-{{ checksum "administration/package.json" }}-{{ checksum "frontend/build-configs/package.json" }}
                paths:
                    - ~/node_modules
                    - ~/administration/node_modules
                    - ~/frontend/build-configs/node_modules
    restore_pods:
        description: Restores and saves the cocoa pods cache.
        steps:
            - restore_cache:
                keys:
                    - 1-pods-{{ arch }}-{{ checksum "frontend/ios/Podfile.lock" }}
                name: Restore CocoaPods Cache
            - run:
                command: |
                    pod update
                    pod install
                name: '[CP] Install CocoaPods'
                working_directory: frontend/ios
            - save_cache:
                key: 1-pods-{{ arch }}-{{ checksum "frontend/ios/Podfile.lock" }}
                name: Save CocoaPods Cache
                paths:
                    - ~/Library/Caches/CocoaPods/
    restore_ruby_cache:
        description: Restores and saves fastlane cache of the passed directory.
        parameters:
            directory:
                default: native
                type: string
        steps:
            - run:
                command: sudo bundle update --bundler
                name: Install bundler
                working_directory: ~/project/frontend/android
            - restore_cache:
                keys:
                    - 2-gems-{{ arch }}-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                    - 2-gems-{{ arch }}-
            - run:
                command: sudo bundle check || sudo bundle install
                name: '[FL] install'
                working_directory: << parameters.directory >>
            - save_cache:
                key: 2-gems-{{ arch }}-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                paths:
                    - << parameters.directory >>/vendor/bundle
    setup_npm_global:
        steps:
            - run:
                command: |-
                    mkdir -p ~/.npm-global
                    npm config set prefix '~/.npm-global'
                    echo 'export PATH=~/.npm-global/bin:"$PATH"' >> "$BASH_ENV"
                name: Setup npm
jobs:
    build_administration:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - install_dart_linux
            - install_protobuf_linux
            - prepare_workspace
            - restore_environment_variables
            - restore_npm_cache
            - run:
                command: npm run generate-graphql
                name: Generate GraphQL
                working_directory: ~/project/administration
            - run:
                command: npm run generate-protobuf
                name: Generate Protobuf
                working_directory: ~/project/administration
            - run:
                command: npm run build --version_name=${NEW_VERSION_NAME}
                name: Build
                working_directory: ~/project/administration
            - store_artifacts:
                path: ~/attached_workspace/build
            - persist_to_workspace:
                paths:
                    - administration/build
                root: ~/project
            - notify
        working_directory: ~/project
    build_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m" -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        parameters:
            buildConfig:
                description: Name of the build config to use
                enum:
                    - bayern
                    - bayernFloss
                    - nuernberg
                    - koblenz
                type: enum
        resource_class: large
        steps:
            - checkout:
                path: ~/project
            - add_ssh_keys:
                fingerprints:
                    - 24:1d:3b:b7:b3:49:69:d7:54:c3:93:a5:a2:d1:71:db
            - install_app_toolbelt
            - prepare_workspace
            - install_dart_linux
            - install_fvm
            - restore_environment_variables
            - restore_ruby_cache:
                directory: ~/project/frontend/android
            - run:
                command: |
                    fvm flutter pub get --enforce-lockfile
                    fvm flutter precache --android
                name: Install Flutter Packages
                working_directory: ~/project/frontend/android
            - run:
                command: bundle exec fastlane keystore
                name: '[FL] Prepare Android Keystore'
                working_directory: ~/project/frontend/android
            - run:
                command: bundle exec fastlane android build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} build_config_name:<< parameters.buildConfig >>
                name: '[FL] Build'
                working_directory: ~/project/frontend/android
            - run:
                command: mkdir -p attached_workspace
                name: Make attached_workspace dir
            - run:
                command: mv ~/project/frontend/build/app/outputs/bundle/<< parameters.buildConfig >>Release/app-<< parameters.buildConfig >>-release.aab ~/attached_workspace/<< parameters.buildConfig >>.aab
                name: Move aab
            - run:
                command: mv ~/project/frontend/build/app/outputs/apk/<< parameters.buildConfig >>/release/app-<< parameters.buildConfig >>-release.apk ~/attached_workspace/<< parameters.buildConfig >>.apk
                name: Move apk
            - persist_to_workspace:
                paths:
                    - << parameters.buildConfig >>.aab
                    - << parameters.buildConfig >>.apk
                root: ~/attached_workspace
            - store_artifacts:
                path: ~/attached_workspace/
            - notify
    build_backend:
        docker:
            - image: cimg/openjdk:17.0.13-node
        environment:
            _JAVA_OPTIONS: -Xmx3g
            GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        steps:
            - checkout:
                path: ~/project
            - setup_remote_docker:
                docker_layer_caching: true
            - run: git submodule sync
            - run: git submodule update --init
            - install_app_toolbelt
            - install_protobuf_linux
            - prepare_workspace
            - restore_cache:
                key: v3-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - restore_cache:
                key: v3-gradle-cache-{{ checksum "build.gradle.kts" }}
            - run: ./gradlew build
            - save_cache:
                key: v3-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
                paths:
                    - ~/gradle/wrapper
            - save_cache:
                key: v3-gradle-cache-{{ checksum "build.gradle.kts" }}
                paths:
                    - ~/.gradle/caches
            - store_artifacts:
                path: ~/attached_workspace/build/libs
            - persist_to_workspace:
                paths:
                    - backend/build/distributions/*
                root: ~/project
            - notify
        working_directory: ~/project/backend
    build_ios:
        macos:
            xcode: 15.2.0
        parameters:
            buildConfig:
                description: Name of the build config to use
                enum:
                    - bayern
                    - bayernFloss
                    - nuernberg
                    - koblenz
                type: enum
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - install_dart_mac
            - install_fvm
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: softwareupdate --install-rosetta --agree-to-license
                name: Install rosetta
            - restore_ruby_cache:
                directory: frontend/ios
            - run:
                command: |
                    fvm flutter pub get --enforce-lockfile
                    fvm flutter precache --ios
                name: Install Flutter Packages
                working_directory: frontend/
            - restore_pods
            - run:
                command: bundle exec fastlane ios build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} build_config_name:<< parameters.buildConfig >>
                name: '[FL] Build'
                working_directory: frontend/ios
            - store_artifacts:
                path: ~/<< parameters.buildConfig >>.ipa
            - persist_to_workspace:
                paths:
                    - << parameters.buildConfig >>.ipa
                root: ~/
            - notify
    build_martin:
        docker:
            - image: rust:bookworm
        steps:
            - checkout:
                path: ~/project
            - run: apt update -y && apt install -y nodejs npm
            - install_app_toolbelt
            - run:
                command: |
                    mkdir -p ~/.ssh
                    touch ~/.ssh/known_hosts
                    echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=" >> ~/.ssh/known_hosts
                    git clone git@github.com:urbica/martin.git ~/martin
                    git config advice.detachedHead false
                    git checkout ed14582a8f5c3e11bfb165f3b012edccd929b479
                name: Checkout
            - restore_cache:
                keys:
                    - v1-cargo-{{ checksum "Cargo.toml" }}-{{ checksum "Cargo.lock" }}
            - prepare_workspace
            - run:
                command: cargo update openssl --precise 0.10.64
                name: Update OpenSSL library due to failed compilation
            - run:
                command: |
                    cargo build --release --target x86_64-unknown-linux-gnu
                name: Build
            - save_cache:
                key: v1-cargo-{{ checksum "Cargo.toml" }}-{{ checksum "Cargo.lock" }}
                paths:
                    - ~/.cargo
                    - target
            - run:
                command: |
                    mkdir -p ~/attached_workspace/artifacts/martin
                    cp target/x86_64-unknown-linux-gnu/release/martin ~/attached_workspace/artifacts/martin
                name: Prepare storing
            - store_artifacts:
                path: ~/attached_workspace/artifacts
            - persist_to_workspace:
                paths:
                    - martin/martin
                root: ~/attached_workspace/artifacts
            - notify
        working_directory: ~/martin
    bump_version:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            platforms:
                default: all
                description: Set one or multiple platforms for git tag f.e. "web" or "web/native"
                type: string
            prepare_delivery:
                default: false
                description: Whether to prepare for a delivery. If true, the version bump is committed.
                type: boolean
        resource_class: small
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - run:
                command: echo "export NEW_VERSION_NAME=$(app-toolbelt v0 version calc | jq .versionName)" >> ${BASH_ENV}
                name: Calculate next version name
            - run:
                command: echo "export NEW_VERSION_CODE=$(app-toolbelt v0 version calc | jq .versionCode)" >> ${BASH_ENV}
                name: Calculate next version code
            - when:
                condition: << parameters.prepare_delivery >>
                steps:
                    - run:
                        command: app-toolbelt v0 release bump-to ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --branch ${CIRCLE_BRANCH} --platforms << parameters.platforms >>
                        name: Bump git version
            - when:
                condition:
                    and:
                        - << parameters.prepare_delivery >>
                        - not:
                            equal:
                                - main
                                - << pipeline.git.branch >>
                steps:
                    - notify:
                        allow-all-branches: true
                        success_message: Delivery was made on branch << pipeline.git.branch >>. Make sure to merge this branch before next delivery.
            - persist_environment_variables
            - notify
    check:
        docker:
            - image: cimg/node:20.18.0-browsers
        environment:
            TOTAL_CPUS: 1
            TZ: Europe/Berlin
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - check_circleci_config
            - notify
    check_administration:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - install_dart_linux
            - install_protobuf_linux
            - prepare_workspace
            - restore_npm_cache
            - run:
                command: npm run generate-graphql
                name: Generate GraphQL
                working_directory: ~/project/administration
            - run:
                command: npm run generate-protobuf
                name: Generate Protobuf
                working_directory: ~/project/administration
            - run:
                command: npm run lint
                name: Lint
                working_directory: ~/project/administration
            - run:
                command: npm run test:coverage -- --maxWorkers=2
                name: Run tests and generate coverage report
                working_directory: ~/project/administration
            - store_artifacts:
                destination: ~/attached_workspace/coverage
                path: ~/project/administration/src/coverage
            - run:
                command: npm run ts:check
                name: Typescript
                working_directory: ~/project/administration
            - notify
        working_directory: ~/project
    check_backend:
        docker:
            - image: cimg/openjdk:17.0.13-node
        environment:
            _JAVA_OPTIONS: -Xmx3g
            GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        steps:
            - checkout:
                path: ~/project
            - setup_remote_docker:
                docker_layer_caching: true
            - run: git submodule sync
            - run: git submodule update --init
            - install_app_toolbelt
            - install_protobuf_linux
            - prepare_workspace
            - restore_cache:
                key: v3-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - restore_cache:
                key: v3-gradle-cache-{{ checksum "build.gradle.kts" }}
            - run:
                command: |
                    ./gradlew run --args="graphql-export ../specs/backend-api.graphql"
                    git diff --exit-code
                name: Check that GraphQL scheme is stable
            - run:
                command: ./gradlew ktlintCheck
                name: Check backend formatting
            - run:
                command: |
                    ./gradlew test
                name: Test
            - store_test_results:
                path: ./build/test-results
            - run:
                command: ./gradlew koverLog koverHtmlReport
                name: Generate test coverage report
            - store_artifacts:
                destination: test-coverage-report
                path: ./build/reports/kover/html
            - save_cache:
                key: v3-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
                paths:
                    - ~/.gradle/wrapper
            - save_cache:
                key: v3-gradle-cache-{{ checksum "build.gradle.kts" }}
                paths:
                    - ~/.gradle/caches
            - notify
        working_directory: ~/project/backend
    check_frontend:
        docker:
            - image: cimg/node:20.18.0
        resource_class: small
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - install_dart_linux
            - install_fvm
            - run:
                command: fvm flutter pub get --enforce-lockfile
                name: Install Flutter Packages
                working_directory: ~/project/frontend/
            - run:
                command: fvm dart format -l 120 -o none --set-exit-if-changed .
                name: Check Formatting
                working_directory: ~/project/frontend/
            - run:
                command: |
                    # Statically use "bayern" build config for analyzing here
                    fvm flutter pub run build_runner build --define "df_build_config=name=bayern"
                name: Build Runner
                working_directory: ~/project/frontend/
            - run:
                command: |
                    fvm flutter analyze --fatal-infos --fatal-warnings
                    fvm flutter analyze pubs/df_build_config --fatal-infos --fatal-warnings
                name: Check Analyzer and Linting
                working_directory: ~/project/frontend/
            - run:
                command: |
                    fvm flutter test
                    fvm flutter test pubs/df_build_config
                name: Tests
                working_directory: ~/project/frontend/
            - notify
    check_health_backend:
        docker:
            - image: debian:12
            - environment:
                - POSTGRES_DB=ehrenamtskarte
                - POSTGRES_USER=postgres
                - POSTGRES_PASSWORD=postgres
              image: postgis/postgis:13-3.0
        steps:
            - checkout:
                path: ~/project
            - attach_workspace:
                at: /tmp/workspace
            - run: apt update -y && apt install -y nodejs npm curl sudo
            - install_app_toolbelt
            - run:
                command: apt install ca-certificates-java -y
                name: Install ca-certificates-java
            - run:
                command: apt install openjdk-17-jre-headless -y
                name: Install openjdk-17-jre-headless
            - run:
                command: dpkg -i /tmp/workspace/debs/backend/eak-backend*.deb
                name: Install backend
            - run:
                command: /opt/ehrenamtskarte/backend/bin/backend migrate
                name: Run migrate
            - run:
                background: true
                command: /opt/ehrenamtskarte/backend/bin/backend execute
                name: Start backend
            - run:
                command: curl --retry 120 --retry-delay 1 --retry-all-errors http://0.0.0.0:8000/health
                name: Check health
            - notify
    deliver_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            buildConfig:
                enum:
                    - bayern
                    - bayernFloss
                    - nuernberg
                    - koblenz
                type: enum
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - prepare_workspace
            - restore_ruby_cache:
                directory: ~/project/frontend/android
            - restore_environment_variables
            - run:
                command: bundle exec fastlane android upload_to_playstore build_config_name:<< parameters.buildConfig >> production_delivery:"<< parameters.production_delivery >>" version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                name: '[FL] Play Store Upload'
                working_directory: ~/project/frontend/android
            - notify
    deliver_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 15.2.0
        parameters:
            buildConfig:
                enum:
                    - bayern
                    - nuernberg
                    - koblenz
                type: enum
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        shell: /bin/bash --login -o pipefail
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - prepare_workspace
            - restore_environment_variables
            - restore_ruby_cache:
                directory: ~/project/frontend/ios
            - when:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios appstoreconnect_upload build_config_name:<< parameters.buildConfig >> ipa_path:attached_workspace/<< parameters.buildConfig >>.ipa version_name:${NEW_VERSION_NAME}
                        name: '[FL] App Store Connect Upload'
                        working_directory: frontend/ios
            - unless:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios upload_to_test_flight build_config_name:<< parameters.buildConfig >> ipa_path:attached_workspace/<< parameters.buildConfig >>.ipa
                        name: '[FL] TestFlight Upload'
                        working_directory: frontend/ios
            - notify
    install_packages_to_server:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            production:
                description: Whether builds are delivered to production or beta.
                type: boolean
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - prepare_workspace
            - when:
                condition: << parameters.production >>
                steps:
                    - run:
                        command: |
                            curl https://webhook.entitlementcard.tuerantuer.org/hooks/install-backend-admin-$EAK_WEBHOOK
                        name: Install packages via webhook
            - unless:
                condition: << parameters.production >>
                steps:
                    - run:
                        command: |
                            curl https://webhook.entitlementcard-test.tuerantuer.org/hooks/install-backend-admin-$EAK_WEBHOOK
                        name: Install packages via webhook
            - notify
    notify_release:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            production_delivery:
                description: Whether builds are delivered to the production or beta lane of the play store.
                type: boolean
        resource_class: small
        steps:
            - install_app_toolbelt
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: echo "export RELEASE_ID='$(app-toolbelt v0 release create all ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} <<# parameters.production_delivery >>--production-release<</ parameters.production_delivery >>)'" >> ${BASH_ENV}
                name: Create github release
            - run:
                command: app-toolbelt v0 release upload --releaseId ${RELEASE_ID} --files "$(ls ~/attached_workspace/*.apk)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload android apks to github release
            - run:
                command: app-toolbelt v0 release upload --releaseId ${RELEASE_ID} --files "$(ls ~/attached_workspace/debs/administration/*.deb)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload administration debian package to github release
            - run:
                command: app-toolbelt v0 release upload --releaseId ${RELEASE_ID} --files "$(ls ~/attached_workspace/debs/backend/*.deb)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload backend debian packages to github release
            - notify:
                allow-all-branches: false
                channel: releases
                success_message: <<^ parameters.production_delivery >>[Beta] <</ parameters.production_delivery >>Ehrenamtskarte Bayern und Sozialpass Nürnberg ${NEW_VERSION_NAME} have been released successfully! https://github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/releases/tag/${NEW_VERSION_NAME}-all
    pack_administration:
        docker:
            - image: debian:12
        steps:
            - checkout:
                path: ~/project
            - run: apt update -y && apt install -y nodejs npm
            - install_app_toolbelt
            - prepare_workspace
            - restore_environment_variables
            - run: ~/project/scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -f ~/attached_workspace/administration/build -d "Administration backend for the Ehrenamtskarte app" -n "eak-administration"
            - run: |
                mkdir -p ~/attached_workspace/debs/administration
                mv *.deb ~/attached_workspace/debs/administration
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/administration/*.deb
                root: ~/attached_workspace
            - notify
    pack_backend:
        docker:
            - image: debian:12
        steps:
            - checkout:
                path: ~/project
            - run: apt update -y && apt install -y nodejs npm
            - install_app_toolbelt
            - prepare_workspace
            - restore_environment_variables
            - run: ~/project/scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -t ~/attached_workspace/backend/build/distributions/*.tar -s ~/project/scripts/eak-backend.service -d "Backend server for the Ehrenamtskarte app" -n "eak-backend" -c "openjdk-17-jre-headless"
            - run: |
                mkdir -p ~/attached_workspace/debs/backend
                mv *.deb ~/attached_workspace/debs/backend
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/backend/*.deb
                root: ~/attached_workspace
            - notify
        working_directory: ~/project/backend
    pack_martin:
        docker:
            - image: debian:12
        steps:
            - checkout:
                path: ~/project
            - run: apt update -y && apt install -y nodejs npm
            - install_app_toolbelt
            - prepare_workspace
            - restore_environment_variables
            - attach_workspace:
                at: /tmp/workspace
            - run:
                command: |
                    cp ~/project/docker/martin-config.yaml config.yaml
                    cp ~/attached_workspace/martin/martin .
                    ~/project/scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -d "Martin tile server for the Ehrenamtskarte app" -n "eak-martin" -s ~/project/scripts/eak-martin.service -C "/opt/ehrenamtskarte/martin/config.yaml" -M .
                name: Build .deb
            - run:
                command: |
                    mkdir -p ~/attached_workspace/debs/backend
                    mv *.deb ~/attached_workspace/debs/backend
                name: Move .deb to artifacts folder
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/backend/*.deb
                root: ~/attached_workspace
            - notify
        working_directory: ~/project/map-tiles/martin
    pack_meta:
        docker:
            - image: debian:12
        steps:
            - checkout:
                path: ~/project
            - run: apt update -y && apt install -y nodejs npm
            - install_app_toolbelt
            - prepare_workspace
            - restore_environment_variables
            - run: ~/project/scripts/pack_deb.sh -v "${NEW_VERSION_NAME}" -d "Meta package for the Ehrenamtskarte app" -n "eak" -c "eak-backend, eak-administration, eak-martin"
            - run: |
                mkdir -p ~/attached_workspace/debs/backend
                cp *.deb ~/attached_workspace/debs/backend
            - store_artifacts:
                path: ~/attached_workspace
            - persist_to_workspace:
                paths:
                    - debs/backend/*.deb
                root: ~/attached_workspace
            - notify
    promote_android:
        docker:
            - image: cimg/android:2024.01.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            build_config_name:
                default: bayern
                enum:
                    - bayern
                    - nuernberg
                type: enum
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - restore_ruby_cache:
                directory: ~/project/frontend/android
            - run:
                command: bundle exec fastlane android playstore_promote build_config_name:<< parameters.build_config_name >>
                name: '[FL] Play Store Promotion'
                working_directory: frontend/android
            - notify
    promote_github_release:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - install_app_toolbelt
            - run:
                command: app-toolbelt v0 release promote --platform all --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Remove prerelease flag from github release
            - notify
    promote_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 15.2.0
        parameters:
            build_config_name:
                default: bayern
                enum:
                    - bayern
                    - nuernberg
                type: enum
        shell: /bin/bash --login -o pipefail
        steps:
            - checkout
            - install_app_toolbelt
            - restore_ruby_cache:
                directory: ~/project/frontend/ios
            - run:
                command: bundle exec fastlane ios appstoreconnect_promote build_config_name:<< parameters.build_config_name >>
                name: '[FL] Appstore Connect Store Promotion'
                working_directory: frontend/ios
            - notify
    promote_to_server:
        docker:
            - image: cimg/node:20.18.0
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - prepare_workspace
            - add_ssh_keys:
                fingerprints:
                    - a1:3f:a7:c3:ff:12:40:1d:85:de:a7:ab:12:3f:cc:05
            - run:
                command: |
                    mkdir -p /home/circleci/.ssh
                    echo ${APT_FINGERPRINT_STAGING} >> /home/circleci/.ssh/known_hosts
                    echo ${APT_FINGERPRINT_PRODUCTION} >> /home/circleci/.ssh/known_hosts
                    scp ci@entitlementcard-test.tuerantuer.org:/srv/local-apt-repository/eak*.deb ci@entitlementcard.tuerantuer.org:/srv/local-apt-repository/
                name: Transfer artifacts to production
            - run:
                command: |
                    curl https://webhook.entitlementcard.tuerantuer.org/hooks/install-backend-admin-$EAK_WEBHOOK
                name: Install administration & backend packages via webhook
            - notify
    upload_packages_to_server:
        docker:
            - image: cimg/node:20.18.0
        parameters:
            bundle:
                description: Defines which bundle should be deployed to the server.
                enum:
                    - administration
                    - backend
                type: enum
            production:
                description: Whether builds are delivered to production or beta.
                type: boolean
        steps:
            - checkout:
                path: ~/project
            - install_app_toolbelt
            - prepare_workspace
            - add_ssh_keys:
                fingerprints:
                    - a1:3f:a7:c3:ff:12:40:1d:85:de:a7:ab:12:3f:cc:05
            - when:
                condition: << parameters.production >>
                steps:
                    - run:
                        command: |
                            mkdir -p /home/circleci/.ssh
                            echo ${APT_FINGERPRINT_PRODUCTION} >> /home/circleci/.ssh/known_hosts
                            echo "Uploading: " ~/attached_workspace/debs/<< parameters.bundle >>/*.deb
                            sftp -b - ci@entitlementcard.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/<< parameters.bundle >>/*.deb"
                        name: SFTP upload package
                    - run:
                        command: |
                            mkdir -p /home/circleci/.ssh
                            echo ${APT_FINGERPRINT_PRODUCTION} >> /home/circleci/.ssh/known_hosts
                            echo "Uploading: " ~/attached_workspace/debs/<< parameters.bundle >>/*.deb
                            sftp -b - ci@entitlementcard.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/<< parameters.bundle >>/*.deb"
                        name: SFTP upload package
            - unless:
                condition: << parameters.production >>
                steps:
                    - run:
                        command: |
                            mkdir -p /home/circleci/.ssh
                            echo ${APT_FINGERPRINT_STAGING} >> /home/circleci/.ssh/known_hosts
                            echo "Uploading: " /home/circleci/attached_workspace/debs/<< parameters.bundle >>/*.deb
                            sftp -b - ci@entitlementcard-test.tuerantuer.org:/srv/local-apt-repository/ \<<< "put -r /home/circleci/attached_workspace/debs/<< parameters.bundle >>/*.deb"
                        name: SFTP upload package
            - notify
orbs:
    browser-tools: circleci/browser-tools@1.4.1
    gradle: circleci/gradle@2.2.0
parameters:
    run_build_frontend:
        default: false
        type: boolean
    run_commit:
        default: true
        type: boolean
    run_commit_main:
        default: run_if_on_main
        enum:
            - run_if_on_main
            - run
            - skip
        type: enum
    run_delivery_beta_all:
        default: false
        type: boolean
    run_delivery_beta_backend_administration:
        default: false
        type: boolean
    run_delivery_beta_frontend:
        default: false
        type: boolean
    run_delivery_production_backend_administration:
        default: false
        type: boolean
    run_delivery_production_frontend:
        default: false
        type: boolean
    run_promotion_all:
        default: false
        type: boolean
    run_promotion_backend_administration:
        default: false
        type: boolean
    run_promotion_frontend:
        default: false
        type: boolean
version: 2.1
workflows:
    build_frontend:
        jobs:
            - check_frontend
            - build_android:
                buildConfig: bayernFloss
                name: frontend-android-build-bayernFloss
                requires:
                    - check_frontend
            - build_android:
                buildConfig: bayern
                name: frontend-android-build-bayern
                requires:
                    - check_frontend
            - build_ios:
                buildConfig: bayern
                name: frontend-ios-build-bayern
                requires:
                    - check_frontend
            - build_android:
                buildConfig: nuernberg
                name: frontend-android-build-nuernberg
                requires:
                    - check_frontend
            - build_ios:
                buildConfig: nuernberg
                name: frontend-ios-build-nuernberg
                requires:
                    - check_frontend
            - build_android:
                buildConfig: koblenz
                name: frontend-android-build-koblenz
                requires:
                    - check_frontend
            - build_ios:
                buildConfig: koblenz
                name: frontend-ios-build-koblenz
                requires:
                    - check_frontend
        when: << pipeline.parameters.run_build_frontend >>
    commit:
        jobs:
            - check
            - check_backend
            - check_administration
            - check_frontend
        when:
            and:
                - << pipeline.parameters.run_commit >>
                - not:
                    equal:
                        - main
                        - << pipeline.git.branch >>
    commit_main:
        jobs:
            - bump_version:
                prepare_delivery: false
            - check
            - check_administration
            - check_backend
            - build_administration:
                requires:
                    - check_administration
                    - bump_version
            - pack_administration:
                requires:
                    - build_administration
            - build_martin
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - build_backend
                    - bump_version
            - check_health_backend:
                requires:
                    - pack_backend
            - pack_martin:
                requires:
                    - build_martin
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - check_frontend
            - build_android:
                buildConfig: bayern
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_bayern
                requires:
                    - bump_version
                    - check_frontend
            - build_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_bayern
                requires:
                    - bump_version
                    - check_frontend
        when:
            or:
                - equal:
                    - << pipeline.parameters.run_commit_main >>
                    - run
                - and:
                    - equal:
                        - << pipeline.parameters.run_commit_main >>
                        - run_if_on_main
                    - equal:
                        - main
                        - << pipeline.git.branch >>
    delivery_beta_all:
        jobs:
            - bump_version:
                context:
                    - deliverino
                prepare_delivery: true
            - check
            - check_frontend:
                requires:
                    - check
            - build_android:
                buildConfig: bayern
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_bayern
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: bayern
                context:
                    - tuerantuer-google-play
                name: deliver_android_bayern
                production_delivery: false
                requires:
                    - build_android_bayern
            - build_android:
                buildConfig: nuernberg
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_nuernberg
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: nuernberg
                context:
                    - tuerantuer-google-play
                name: deliver_android_nuernberg
                production_delivery: false
                requires:
                    - build_android_nuernberg
            - build_android:
                buildConfig: koblenz
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: koblenz
                context:
                    - tuerantuer-google-play
                name: deliver_android_koblenz
                production_delivery: false
                requires:
                    - build_android_koblenz
            - build_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_bayern
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                name: deliver_ios_bayern
                production_delivery: false
                requires:
                    - build_ios_bayern
            - build_ios:
                buildConfig: nuernberg
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_nuernberg
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: nuernberg
                context:
                    - tuerantuer-apple
                name: deliver_ios_nuernberg
                production_delivery: false
                requires:
                    - build_ios_nuernberg
            - build_ios:
                buildConfig: koblenz
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: koblenz
                context:
                    - tuerantuer-apple
                name: deliver_ios_koblenz
                production_delivery: false
                requires:
                    - build_ios_koblenz
            - check_administration
            - build_administration:
                requires:
                    - check_administration
                    - bump_version
            - pack_administration:
                requires:
                    - build_administration
            - build_martin
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - build_backend
                    - bump_version
            - check_health_backend:
                requires:
                    - pack_backend
            - pack_martin:
                requires:
                    - build_martin
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - upload_packages_to_server:
                bundle: administration
                context:
                    - credentials-ehrenamtskarte
                name: upload_administration_packages_to_server_staging
                production: false
                requires:
                    - pack_administration
                    - check_health_backend
                    - pack_martin
                    - pack_meta
            - upload_packages_to_server:
                bundle: backend
                context:
                    - credentials-ehrenamtskarte
                name: upload_backend_packages_to_server_staging
                production: false
                requires:
                    - pack_administration
                    - check_health_backend
                    - pack_martin
                    - pack_meta
            - install_packages_to_server:
                context:
                    - credentials-ehrenamtskarte
                name: install_packages_to_server_staging
                production: false
                requires:
                    - upload_administration_packages_to_server_staging
                    - upload_backend_packages_to_server_staging
            - notify_release:
                context:
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_android_bayern
                    - deliver_android_nuernberg
                    - deliver_android_koblenz
                    - deliver_ios_bayern
                    - deliver_ios_nuernberg
                    - deliver_ios_koblenz
                    - install_packages_to_server_staging
        when: << pipeline.parameters.run_delivery_beta_all >>
    delivery_beta_backend_administration:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: web
                prepare_delivery: true
            - check_administration
            - build_administration:
                requires:
                    - check_administration
                    - bump_version
            - pack_administration:
                requires:
                    - build_administration
            - build_martin
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - build_backend
                    - bump_version
            - check_health_backend:
                requires:
                    - pack_backend
            - pack_martin:
                requires:
                    - build_martin
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - upload_packages_to_server:
                bundle: administration
                context:
                    - credentials-ehrenamtskarte
                name: upload_administration_packages_to_server_staging
                production: false
                requires:
                    - pack_administration
                    - check_health_backend
                    - pack_martin
                    - pack_meta
            - upload_packages_to_server:
                bundle: backend
                context:
                    - credentials-ehrenamtskarte
                name: upload_backend_packages_to_server_staging
                production: false
                requires:
                    - pack_administration
                    - check_health_backend
                    - pack_martin
                    - pack_meta
            - install_packages_to_server:
                context:
                    - credentials-ehrenamtskarte
                name: install_packages_to_server_staging
                production: false
                requires:
                    - upload_administration_packages_to_server_staging
                    - upload_backend_packages_to_server_staging
            - notify_release:
                context:
                    - deliverino
                production_delivery: false
                requires:
                    - install_packages_to_server_staging
        when: << pipeline.parameters.run_delivery_beta_backend_administration >>
    delivery_beta_frontend:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: native
                prepare_delivery: true
            - check
            - check_frontend:
                requires:
                    - check
            - build_android:
                buildConfig: bayern
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_bayern
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: bayern
                context:
                    - tuerantuer-google-play
                name: deliver_android_bayern
                production_delivery: false
                requires:
                    - build_android_bayern
            - build_android:
                buildConfig: nuernberg
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_nuernberg
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: nuernberg
                context:
                    - tuerantuer-google-play
                name: deliver_android_nuernberg
                production_delivery: false
                requires:
                    - build_android_nuernberg
            - build_android:
                buildConfig: koblenz
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: koblenz
                context:
                    - tuerantuer-google-play
                name: deliver_android_koblenz
                production_delivery: false
                requires:
                    - build_android_koblenz
            - build_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_bayern
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                name: deliver_ios_bayern
                production_delivery: false
                requires:
                    - build_ios_bayern
            - build_ios:
                buildConfig: nuernberg
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_nuernberg
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: nuernberg
                context:
                    - tuerantuer-apple
                name: deliver_ios_nuernberg
                production_delivery: false
                requires:
                    - build_ios_nuernberg
            - build_ios:
                buildConfig: koblenz
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_koblenz
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: koblenz
                context:
                    - tuerantuer-apple
                name: deliver_ios_koblenz
                production_delivery: false
                requires:
                    - build_ios_koblenz
            - notify_release:
                context:
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_android_bayern
                    - deliver_android_nuernberg
                    - deliver_android_koblenz
                    - deliver_ios_bayern
                    - deliver_ios_nuernberg
                    - deliver_ios_koblenz
        when: << pipeline.parameters.run_delivery_beta_frontend >>
    delivery_production_backend_administration:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: web
                prepare_delivery: true
            - check_administration
            - build_administration:
                requires:
                    - check_administration
                    - bump_version
            - pack_administration:
                requires:
                    - build_administration
            - build_martin
            - check_backend
            - build_backend:
                requires:
                    - check_backend
            - pack_backend:
                requires:
                    - build_backend
                    - bump_version
            - check_health_backend:
                requires:
                    - pack_backend
            - pack_martin:
                requires:
                    - build_martin
                    - bump_version
            - pack_meta:
                requires:
                    - bump_version
            - upload_packages_to_server:
                bundle: administration
                context:
                    - credentials-ehrenamtskarte
                name: upload_administration_packages_to_server_production
                production: true
                requires:
                    - pack_administration
                    - check_health_backend
                    - pack_martin
                    - pack_meta
            - upload_packages_to_server:
                bundle: backend
                context:
                    - credentials-ehrenamtskarte
                name: upload_backend_packages_to_server_production
                production: true
                requires:
                    - pack_administration
                    - check_health_backend
                    - pack_martin
                    - pack_meta
            - install_packages_to_server:
                context:
                    - credentials-ehrenamtskarte
                name: install_packages_to_server_production
                production: true
                requires:
                    - upload_administration_packages_to_server_production
                    - upload_backend_packages_to_server_production
            - notify_release:
                context:
                    - deliverino
                production_delivery: true
                requires:
                    - install_packages_to_server_production
        when: << pipeline.parameters.run_delivery_production_backend_administration >>
    delivery_production_frontend:
        jobs:
            - bump_version:
                context:
                    - deliverino
                platforms: native
                prepare_delivery: true
            - check_frontend
            - build_android:
                buildConfig: bayern
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_bayern
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: bayern
                context:
                    - tuerantuer-google-play
                name: deliver_android_bayern
                production_delivery: true
                requires:
                    - build_android_bayern
            - build_android:
                buildConfig: nuernberg
                context:
                    - credentials-repo
                    - credentials-ehrenamtskarte
                name: build_android_nuernberg
                requires:
                    - bump_version
                    - check_frontend
            - deliver_android:
                buildConfig: nuernberg
                context:
                    - tuerantuer-google-play
                name: deliver_android_nuernberg
                production_delivery: true
                requires:
                    - build_android_nuernberg
            - build_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_bayern
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: bayern
                context:
                    - tuerantuer-apple
                name: deliver_ios_bayern
                production_delivery: true
                requires:
                    - build_ios_bayern
            - build_ios:
                buildConfig: nuernberg
                context:
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ios_nuernberg
                requires:
                    - bump_version
                    - check_frontend
            - deliver_ios:
                buildConfig: nuernberg
                context:
                    - tuerantuer-apple
                name: deliver_ios_nuernberg
                production_delivery: true
                requires:
                    - build_ios_nuernberg
            - notify_release:
                context:
                    - deliverino
                production_delivery: true
                requires:
                    - deliver_ios_bayern
                    - deliver_ios_nuernberg
                    - deliver_android_bayern
                    - deliver_android_nuernberg
        when: << pipeline.parameters.run_delivery_production_frontend >>
    promotion_all:
        jobs:
            - promote_android:
                build_config_name: bayern
                context:
                    - mattermost
                    - tuerantuer-google-play
                name: promote_bayern_android
            - promote_android:
                build_config_name: nuernberg
                context:
                    - mattermost
                    - tuerantuer-google-play
                name: promote_nuernberg_android
            - promote_ios:
                build_config_name: bayern
                context:
                    - mattermost
                    - tuerantuer-apple
                name: promote_bayern_ios
            - promote_ios:
                build_config_name: nuernberg
                context:
                    - mattermost
                    - tuerantuer-apple
                name: promote_nuernberg_ios
            - promote_to_server:
                context:
                    - credentials-ehrenamtskarte
                name: promote_backend_administration
            - promote_github_release:
                context:
                    - deliverino
        when: << pipeline.parameters.run_promotion_all >>
    promotion_backend_administration:
        jobs:
            - promote_to_server:
                context:
                    - credentials-ehrenamtskarte
                name: promote_backend_administration
        when: << pipeline.parameters.run_promotion_backend_administration >>
    promotion_frontend:
        jobs:
            - promote_android:
                build_config_name: bayern
                context:
                    - mattermost
                    - tuerantuer-google-play
                name: promote_bayern_android
            - promote_android:
                build_config_name: nuernberg
                context:
                    - mattermost
                    - tuerantuer-google-play
                name: promote_nuernberg_android
            - promote_ios:
                build_config_name: bayern
                context:
                    - mattermost
                    - tuerantuer-apple
                name: promote_bayern_ios
            - promote_ios:
                build_config_name: nuernberg
                context:
                    - mattermost
                    - tuerantuer-apple
                name: promote_nuernberg_ios
        when: << pipeline.parameters.run_promotion_frontend >>

